<!DOCTYPE html>
<html lang="ru">
<head>
	<title>JS TEST</title>
	<meta charset="windows-1251" />
  <link href='http://fonts.googleapis.com/css?family=Open+Sans&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
	
	<script src="http://code.jquery.com/jquery-latest.js"></script>
  <script type="text/javascript" src="jQuery.js"></script>
  <script src="jquery.transit.min.js"></script>
  <script src="jquery.scrollTo-1.4.3.1-min.js"></script>
	
<style>
html {
  margin: 0px;
  padding: 0px;
  overflow: hidden;
}
body {
  margin: 0px;
  padding: 0px;
  background-color: #111;
  overflow: hidden;
  font-family: monospace;
  font-size: 10pt;
  color: #fff;
}

div[contenteditable="true"]:focus {
  outline: none;
}

.right {
  float: right;
}
.hidden {
  display: none;
}


</style>

<script>

$(document).ready(function () {

  function list_to_string(list) {
    var string = "";
    for (var l=0; l<list.length; l++) {
      string = string + list[l];
    };
    return string;
  };

  var strategy = {
    'voc' : {
      'literals' : [
        [ '{' , '}' ],
        [ '[' , ']' ],
        [ '<' , '>' ],
        [ '</' , '>' ],
        [ '"' , '"' ],
        [ "'" , "'" ],
      ],
      'HTML' : {
        'tags' : [
         "a",
         "abbr",
         "acronym",
         "address",
         "applet",
         "article",
         "aside",
         "audio",
         "b",
         "basefont",
         "bdi",
         "bdo",
         "bgsound",
         "blockquote",
         "big",
         "body",
         "blink",
         "button",
         "canvas",
         "caption",
         "center",
         "cite",
         "code",
         "colgroup",
         "comment",
         "datalist",
         "dd",
         "del",
         "details",
         "dfn",
         "dir",
         "div",
         "dl",
         "dt",
         "em",
         "fieldset",
         "figcaption",
         "figure",
         "font",
         "form",
         "footer",
         "frame",
         "frameset",
         "h1",
         "h2",
         "h3",
         "h4",
         "h5",
         "h6",
         "head",
         "header",
         "hgroup",
         "html",
         "i",
         "iframe",
         "ins",
         "isindex",
         "kbd",
         "label",
         "legend",
         "li",
         "main",
         "map",
         "marquee",
         "mark",
         "menu",
         "meter",
         "nav",
         "nobr",
         "noembed",
         "noframes",
         "noscript",
         "object",
         "ol",
         "optgroup",
         "option",
         "output",
         "p",
         "plaintext",
         "pre",
         "progress",
         "q",
         "rp",
         "rt",
         "ruby",
         "s",
         "samp",
         "script",
         "section",
         "select",
         "small",
         "span",
         "strike",
         "strong",
         "style",
         "sub",
         "summary",
         "sup",
         "table",
         "tbody",
         "td",
         "textarea",
         "tfoot",
         "th",
         "thead",
         "time",
         "title",
         "tr",
         "tt",
         "u",
         "ul",
         "var",
         "video",
         "xmp",
        ],
        'inline_tags' : [
          "area",
          "base",
          "br",
          "col",
          "command",
          "embed",
          "hr",
          "img",
          "input",
          "keygen",
          "link",
          "meta",
          "param",
          "source",
          "wbr",
        ],
      },
    },
    'methods' : {
      'cut' : {
        'before' : function (string, before) {
          var offset = string.indexOf(before);
          if (offset != -1) {
            string = string.substr(offset);
          };
          return string;
        },
        'after' : function (string, after) {
          var offset = string.indexOf(after);
          if (offset != -1) {
            string = string.substr(0,offset+after.length);
          };
          return string;
        },
        'inside' : function (string, borders) {
          var literals = strategy['voc']['literals'];
          if (typeof borders == 'string') {
            for (var i=0; i<literals.length; i++) {
              if (borders == literals[i][0] && string.indexOf(literals[i][0]) != -1 && string.lastIndexOf(literals[i][1]) != -1 ) {
                var from = string.indexOf(literals[i][0]);
                var to = string.lastIndexOf(literals[i][1]);
              };
            };
          } else if (typeof borders == 'object' && string.indexOf(borders[0]) != -1 && string.lastIndexOf(borders[1]) != -1) {
            var from = string.indexOf(borders[0])+borders[0].length-1;
            var to = string.lastIndexOf(borders[1]);
          };
          string = string.substr(from+1,to-from-1);
          return string;
        },
        'outside' : function (string, borders) {
          var literals = strategy['voc']['literals'];
          if (typeof borders == 'string') {
            for (var i=0; i<literals.length; i++) {
              if (borders == literals[i][0] && string.indexOf(literals[i][0]) != -1 && string.lastIndexOf(literals[i][1]) != -1) {
                var from = string.indexOf(literals[i][0]);
                var to = string.lastIndexOf(literals[i][1]);
              };
            };
          } else if (typeof borders == 'object' && string.indexOf(borders[0]) != -1 && string.lastIndexOf(borders[1]) != -1) {
            var from = string.indexOf(borders[0]);
            var to = string.lastIndexOf(borders[1])+borders[1].length;
          };
          string = string.substr(from,to-from);
          return string;
        },
      },
      'list_in_string' : function (list, string) {
        var index_list = [];
        for (var i=0; i<list.length; i++) {
          if (string.search(list[i]) != -1) {
            index_list.push(list[i]);
          };
        };
        if (index_list.length == 0) {
          index_list = -1;
        };
        return index_list;
      },
    },
    'render' : {
      'HTML' : {
        'tag' : function (block_value) {
          var code = "";
          for (var i=0; i<block_value.length; i++) {
            var result = "";
            var inner = "";
            if (typeof block_value[i]['inner'] == 'object') {
              inner = strategy['render']['HTML']['tag'](block_value[i]['inner']['value']);
            } else if (typeof block_value[i]['inner'] == 'string') {
              inner = block_value[i]['inner'];
            };
            var attrs = [];
            if (block_value[i]['attrs'] != undefined || block_value['attrs'][i].length != 0) {
              for (var a=0; a<block_value[i]['attrs'].length; a++) {
                var attr = " "+block_value[i]['attrs'][a]['name']+'="'+block_value[i]['attrs'][a]['value']+'"';
                attrs.push(attr)
              }
              attrs = list_to_string(attrs);
            };
            var tag = [
              '<',
              block_value[i]['keyword'],
              attrs,
              '>',
              inner,
              '</',
              block_value[i]['keyword'],
              '>',
            ];
            result = list_to_string(tag);
            code = code + result;
          };
          return code;
        },
      },
    },
    'parser' : {
      'html' : function (code) {
      //Step 1. Cut all outside <html> tag
        code = strategy['methods']['cut']['outside'](code,['<html>','</html>']);
      //Step 2. Split by tags
        code = code.replace(/>/g, '>%???%').replace(/</g, '%???%<').split('%???%');
      //Step 3. Mark open and close tags, inner text
        for (var i=0; i<code.length; i++) {
          if (code[i].substr(0,1) == '<') {
            if (code[i].substr(0,2) == '</') {
              code[i] = {
                'type' : 'close_tag',
                'value' : code[i],
              };
            } else {
              code[i] = {
                'type' : 'open_tag',
                'value' : code[i],
              };
            };
          } else {
            code[i] = {
              'type' : 'inner_text',
              'value' : code[i],
            };
          };
        };
      //Step 4. Inline tags
        var tmp_list = [];
        for (var i=0; i<code.length; i++) {
          if (code[i]['value'] != "") {
            if (code[i]['type'] == 'open_tag' && strategy['methods']['list_in_string'](strategy['voc']['HTML']['inline_tags'], code[i]['value']) != -1) {
              code[i]['type'] = 'inline_tag';
            };
            tmp_list.push(code[i]);
          };
        };
        code = tmp_list;
      //Step 5. Levels
        var lvl = 0;
        for (var i=0; i<code.length; i++) {
          if (code[i]['type'] == 'open_tag') {
            code[i]['level'] = lvl;
            lvl = lvl + 1;
          } else if (code[i]['type'] == 'close_tag') {
            lvl = lvl - 1;
            code[i]['level'] = lvl;
          } else if (code[i]['type'] == 'inline_tag') {
            code[i]['level'] = lvl;
          } else if (code[i]['type'] == 'inner_text') {
            code[i]['level'] = lvl;
          };
        };
      //Step 6.

        alert(JSON.stringify(code));
      },
    },
  };

  var tree = {
    'block_type' : {
      'lang' : 'HTML',
      'exp' : 'tag'
    },
    'value' : [
      {
        'keyword' : 'div',
        'attrs' : [
          {
            'name' : 'class',
            'value' : 'test_div',
          },
          {
            'name' : 'name',
            'value' : 'test_name',
          },
        ],
        'inner' : {
          'block_type' : {
            'lang' : 'HTML',
            'exp' : 'tag'
          },
          'value' : [
            {
              'keyword' : 'p',
              'attrs' : [
                {
                  'name' : 'class',
                  'value' : 'test_p',
                },
              ],
              'inner' : {
                'block_type' : {
                  'lang' : 'HTML',
                  'exp' : 'tag'
                },
                'value' : [
                  {
                    'keyword' : 'a',
                    'attrs' : [
                      {
                        'name' : 'class',
                        'value' : 'test_a',
                      },
                    ],
                    'inner' : "TEXT"
                  },
                ],
              }
            },
          ],
        }
      },
      {
        'keyword' : 'div',
        'attrs' : [
          {
            'name' : 'class',
            'value' : 'test_div',
          },
        ],
        'inner' : {
          'block_type' : {
            'lang' : 'HTML',
            'exp' : 'tag'
          },
          'value' : [
            {
              'keyword' : 'p',
              'attrs' : [
                {
                  'name' : 'class',
                  'value' : 'test_p',
                },
              ],
              'inner' : "TEXT"
            },
          ],
        }
      },
    ],
  };

  function render(object) {
    if (typeof object == 'object' && object['block_type'] != undefined && object['value'] != undefined) {
      var block_lang = object['block_type']['lang'];
      var block_exp = object['block_type']['exp'];
      var code = strategy['render'][block_lang][block_exp](object['value']);
      return code;
    };
  };

  function parser(code) {
    if (typeof code == 'string') {
      var block_lang = "HTML"; //Temporary!!! Gets from the key
      var tree = strategy['parser'][block_lang](code);
    };
  };

  var tree_code = render(tree);
  $("#code").text(tree_code);

  //var new_tree = parser(tree_code);
  strategy['parser']['html']("a<html>aa<div><meta />inner</div></html>jjsf");

});

</script>

</head>
	
<body>

<div id="code" style="padding:10px; width:400px;"></div>
<div id="bt" style="padding:10px; width:600px;"></div>


</body>
</html>